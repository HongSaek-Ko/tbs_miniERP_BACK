<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.baek.tbs_miniERP_BACK.mapper.AssetHistoryMapper">


    <!-- Oracle -->
<!--    <insert id="createHistory">-->
<!--        INSERT ALL-->
<!--        <foreach collection="list" item="h">-->
<!--            INTO asset_history (-->
<!--                asset_id,-->
<!--                asset_hold_emp_his,-->
<!--                asset_hold_emp,-->
<!--                asset_history_desc-->
<!--            ) VALUES (-->
<!--                #{h.assetId},-->
<!--                #{h.holdEmpHis, jdbcType=VARCHAR},-->
<!--                #{h.holdEmp, jdbcType=VARCHAR},-->
<!--                #{h.historyDesc, jdbcType=VARCHAR}-->
<!--            )-->
<!--        </foreach>-->
<!--        SELECT 1 FROM DUAL-->
<!--    </insert>-->

    <!-- Postgresql -->
    <insert id="createHistory" parameterType="java.util.List">
        INSERT INTO asset_history (
            asset_id,
            asset_hold_emp_his,
            asset_hold_emp,
            asset_history_desc
        )
        VALUES
        <foreach collection="list" item="h" separator=",">
            (
                #{h.assetId},
                #{h.holdEmpHis, jdbcType=VARCHAR},
                #{h.holdEmp, jdbcType=VARCHAR},
                #{h.historyDesc, jdbcType=VARCHAR}
            )
        </foreach>
    </insert>

    <select id="findByAssetId" resultType="com.baek.tbs_miniERP_BACK.dto.AssetHistoryListDTO">
        SELECT
            a.asset_history_seq AS assetHistorySeq,
            a.asset_id          AS assetId,
            a.asset_id || '_H' || LPAD(
                (ROW_NUMBER() OVER (
                    PARTITION BY a.asset_id
                    ORDER BY a.asset_history_date, a.asset_history_seq
                ))::text, 3, '0'
            ) AS displayId,

            a.asset_hold_emp AS assetHoldEmp,
            a.asset_hold_emp_his AS assetHoldEmpHis,
            a.asset_history_desc AS assetHistoryDesc,
            CAST(a.asset_history_date AS TIMESTAMP) AS assetHistoryDate,

            <!-- '신규' = (자산별)이력일자 최상위(RN 1) -->
            CASE
                WHEN ROW_NUMBER() OVER (
                    PARTITION BY a.asset_id
                    ORDER BY a.asset_history_date, a.asset_history_seq) = 1
            THEN 1 ELSE 0
            END AS isFirst,

            <!-- '이관' = ('이전 소유자' != '현재 소유자') -->
            CASE
                WHEN a.asset_hold_emp_his IS NOT NULL
                AND a.asset_hold_emp_his != a.asset_hold_emp
            THEN 1 ELSE 0
            END AS isTransfer,

            <!-- '폐기' = 비고(사유)에 '폐기'가 포함된 경우 -->
            CASE
                WHEN STRPOS(COALESCE(a.asset_history_desc, ''), '폐기') > 0
            THEN 1 ELSE 0
            END AS isDispose
        FROM asset_history a
        WHERE a.asset_id = #{assetId}
        ORDER BY a.asset_history_date DESC, a.asset_history_seq DESC
    </select>

</mapper>