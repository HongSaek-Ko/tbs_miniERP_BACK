<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baek.tbs_miniERP_BACK.mapper.AssetMapper">

    <!-- 자산 단일 조회 (유효성 검사 등) -->
    <select id="findAssetByAssetId" parameterType="String" resultType="com.baek.tbs_miniERP_BACK.dto.AssetDTO">
        SELECT
            asset_id        AS assetId,
            asset_status    AS assetStatus
        FROM asset
        WHERE asset_id = #{assetId}
    </select>

    <!-- 자산 다음 번호 조회 (등록용) -->
    <select id="findMaxIdByAssetType" parameterType="String">
        SELECT MAX(asset_id) FROM asset WHERE LOWER(asset_type) LIKE '%' || LOWER(#{assetType}) || '%'
    </select>

    <!-- 자산 전체 조회 (일반) -->
    <select id="findAll" parameterType="String" resultType="com.baek.tbs_miniERP_BACK.dto.AssetListDTO">
        SELECT
           a.asset_id               AS assetId,
           a.asset_type             AS assetType,
           a.asset_manufacturer     AS assetManufacturer,
           a.asset_model_name       AS assetModelName,
           a.asset_sn               AS assetSn,
           a.asset_manufactured_at  AS assetManufacturedAt,
           e.emp_name               AS empName,
           e.emp_pos                AS empPos,
           t.team_name              AS teamName,
           a.asset_loc              AS assetLoc,
           a.asset_issuance_date    AS assetIssuanceDate,
           a.asset_desc             AS assetDesc
        FROM asset a
        LEFT JOIN employee e
        ON a.emp_id = e.emp_id
        LEFT JOIN team t
        ON t.team_id = e.team_id
        WHERE a.asset_status = #{assetStatus}
        ORDER BY a.asset_ID
    </select>

    <!-- 자산 전체 조회 (엑셀 내보내기) -->
    <select id="findAllForExport" resultType="com.baek.tbs_miniERP_BACK.dto.AssetListDTO">
        SELECT
            a.asset_id               AS assetId,
            a.asset_type             AS assetType,
            a.asset_manufacturer     AS assetManufacturer,
            a.asset_model_name       AS assetModelName,
            a.asset_sn               AS assetSn,
            a.asset_manufactured_at  AS assetManufacturedAt,
            e.emp_name               AS empName,
            e.emp_pos                AS empPos,
            t.team_name              AS teamName,
            a.asset_loc              AS assetLoc,
            a.asset_issuance_date    AS assetIssuanceDate,
            a.asset_desc             AS assetDesc
        FROM asset a
        LEFT JOIN employee e
        ON a.emp_id = e.emp_id
        LEFT JOIN team t
        ON t.team_id = e.team_id
        <where>
            <if test="p.assetType != null and p.assetType.trim() != ''">
                AND LOWER(a.asset_type) LIKE '%' || LOWER(#{p.assetType}) || '%'
            </if>
            <if test="p.empName != null and p.empName.trim() != ''">
                AND LOWER(e.emp_name) LIKE '%' || LOWER(#{p.empName}) || '%'
            </if>
            <if test="p.empPos != null and p.empPos.trim() != ''">
                AND LOWER(e.emp_pos) LIKE '%' || LOWER(#{p.empPos}) || '%'
            </if>
            <if test="p.teamName != null and p.teamName.trim() != ''">
                AND LOWER(t.team_name) LIKE '%' || LOWER(#{p.teamName}) || '%'
            </if>
            <if test="p.assetLoc != null and p.assetLoc.trim() != ''">
                AND LOWER(a.asset_loc) LIKE '%' || LOWER(#{p.assetLoc}) || '%'
            </if>
            <if test="p.assetDesc != null and p.assetDesc.trim() != ''">
                AND LOWER(a.asset_desc) LIKE '%' || LOWER(#{p.assetDesc}) || '%'
            </if>
            <if test="p.assetStatus != null and p.assetStatus.trim() != ''">
                AND LOWER(a.asset_status) LIKE '%' || LOWER(#{p.assetStatus}) || '%'
            </if>
            <!-- globalSearch: -토큰(제외) -->
            <foreach collection="t.mustExclude" item="token">
                AND NOT (
                    LOWER(a.asset_type) LIKE '%' || #{token} || '%'
                    OR LOWER(e.emp_name) LIKE '%' || #{token} || '%'
                    OR LOWER(e.emp_pos) LIKE '%' || #{token} || '%'
                    OR LOWER(t.team_name) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_loc) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_desc) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_status) LIKE '%' || #{token} || '%'
                )
            </foreach>

            <!-- globalSearch: +토큰(필수) -->
            <foreach collection="t.mustInclude" item="token">
                AND (
                    LOWER(a.asset_type) LIKE '%' || #{token} || '%'
                    OR LOWER(e.emp_name) LIKE '%' || #{token} || '%'
                    OR LOWER(e.emp_pos) LIKE '%' || #{token} || '%'
                    OR LOWER(t.team_name) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_loc) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_desc) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_status) LIKE '%' || #{token} || '%'
                )
            </foreach>

            <!-- globalSearch: 일반토큰(AND 규칙 그대로) -->
            <foreach collection="t.include" item="token">
                AND (
                    LOWER(a.asset_type) LIKE '%' || #{token} || '%'
                    OR LOWER(e.emp_name) LIKE '%' || #{token} || '%'
                    OR LOWER(e.emp_pos) LIKE '%' || #{token} || '%'
                    OR LOWER(t.team_name) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_loc) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_desc) LIKE '%' || #{token} || '%'
                    OR LOWER(a.asset_status) LIKE '%' || #{token} || '%'
                )
            </foreach>
        </where>
        ORDER BY a.asset_id
    </select>

    <!-- 시리얼 번호 조회 (자산 등록 전 검증용) -->
    <select id="validSn">
        SELECT COUNT(*)
        FROM asset
        WHERE asset_sn IN
        <foreach collection="list" item="sn" open="(" close=")" separator=",">
            #{sn}
        </foreach>
    </select>

    <!-- 신규 자산 등록 (다중) (Oracle) -->
<!--    <insert id="createAssets">-->
<!--        INSERT ALL-->
<!--        <foreach collection="list" item="item">-->
<!--            INTO-->
<!--                asset-->
<!--                (-->
<!--                    asset_id,-->
<!--                    asset_type,-->
<!--                    asset_manufacturer,-->
<!--                    asset_manufactured_at,-->
<!--                    asset_model_name,-->
<!--                    asset_sn,-->
<!--                    emp_id,-->
<!--                    asset_loc,-->
<!--                    asset_issuance_date,-->
<!--                    asset_desc,-->
<!--                    asset_reg_dt,-->
<!--                    asset_status-->
<!--                )-->
<!--            VALUES-->
<!--                (-->
<!--                    #{item.assetId},-->
<!--                    #{item.assetType},-->
<!--                    #{item.assetManufacturer},-->
<!--                    #{item.assetManufacturedAt},-->
<!--                    #{item.assetModelName},-->
<!--                    #{item.assetSn},-->
<!--                    #{item.empId},-->
<!--                    #{item.assetLoc},-->
<!--                    #{item.assetIssuanceDate},-->
<!--                    #{item.assetDesc},-->
<!--                    #{item.assetRegDt},-->
<!--                    #{item.assetStatus}-->
<!--                )-->
<!--        </foreach>-->
<!--        SELECT 1 FROM DUAL-->
<!--    </insert>-->

    <!-- 신규 자산 (Postgresql) -->
    <insert id="createAssets" parameterType="java.util.List">
        INSERT INTO asset (
        asset_id,
        asset_type,
        asset_manufacturer,
        asset_manufactured_at,
        asset_model_name,
        asset_sn,
        emp_id,
        asset_loc,
        asset_issuance_date,
        asset_desc,
        asset_reg_dt,
        asset_status
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.assetId},
            #{item.assetType},
            #{item.assetManufacturer},
            to_timestamp(#{item.assetManufacturedAt}, 'YYYY-MM-DD'),
            #{item.assetModelName},
            #{item.assetSn},
            #{item.empId},
            #{item.assetLoc},
            to_timestamp(#{item.assetIssuanceDate}, 'YYYY-MM-DD'),
            #{item.assetDesc},
            COALESCE(#{item.assetRegDt}, now()),
            COALESCE(#{item.assetStatus}, 'HOLD')
            )
        </foreach>
    </insert>

    <!-- 등록 시 SN 유효성 검사 (PG) -->
    <!-- 요청-DB 중복체크 -->
    <select id="countSnConflicts" resultType="int">
        WITH req(asset_id, new_sn) AS (
        VALUES
        <foreach collection="list" item="r" separator=",">
            (#{r.assetId}, #{r.assetSn})
        </foreach>
        )
        SELECT COUNT(*)
        FROM req
        JOIN asset a
        ON a.asset_sn = req.new_sn
        AND a.asset_id != req.asset_id
    </select>

    <!-- DTO 자체 중복체크 -->
    <select id="countSnDupInReq" resultType="int">
        WITH req(asset_id, new_sn) AS (
        VALUES
        <foreach collection="list" item="r" separator=",">
            (#{r.assetId}, #{r.assetSn})
        </foreach>
        )
        SELECT COUNT(*)
        FROM (
        SELECT new_sn
        FROM req
        GROUP BY new_sn
        HAVING COUNT(*) > 1
        ) t
    </select>

    <!-- ORA -->
<!--    <select id="countSnConflicts" resultType="int">-->
<!--        WITH req(asset_id, new_sn) AS (-->
<!--        <foreach collection="list" item="r" separator=" UNION ALL ">-->
<!--            SELECT #{r.assetId} AS asset_id, #{r.assetSn} AS new_sn FROM dual-->
<!--        </foreach>-->
<!--        )-->
<!--        SELECT COUNT(*)-->
<!--        FROM req-->
<!--        JOIN asset a-->
<!--        ON a.asset_sn = req.new_sn-->
<!--        AND a.asset_id != req.asset_id-->
<!--    </select>-->

<!--    <select id="countSnDupInReq" resultType="int">-->
<!--        WITH req(asset_id, new_sn) AS (-->
<!--        <foreach collection="list" item="r" separator=" UNION ALL ">-->
<!--            SELECT #{r.assetId} AS asset_id, #{r.assetSn} AS new_sn FROM dual-->
<!--        </foreach>-->
<!--        )-->
<!--        SELECT COUNT(*)-->
<!--        FROM (-->
<!--        SELECT new_sn-->
<!--        FROM req-->
<!--        GROUP BY new_sn-->
<!--        HAVING COUNT(*) > 1-->
<!--        )-->
<!--    </select>-->

    <!-- 자산 정보 수정 (ORA) -->
<!--    <update id="updateAssets" parameterType="java.util.List">-->
<!--        <foreach collection="list" item="item" separator=";" open="DECLARE BEGIN" close="; END;">-->
<!--            UPDATE-->
<!--                asset-->
<!--            SET-->
<!--                asset_manufacturer      = #{item.assetManufacturer},-->
<!--                asset_manufactured_at   = #{item.assetManufacturedAt},-->
<!--                asset_model_name        = #{item.assetModelName},-->
<!--                emp_id                  = #{item.empId},-->
<!--                asset_sn                = #{item.assetSn},-->
<!--                asset_loc               = #{item.assetLoc},-->
<!--                asset_issuance_date     = #{item.assetIssuanceDate},-->
<!--                asset_desc              = #{item.assetDesc}-->
<!--            WHERE-->
<!--                asset_id = #{item.assetId}-->
<!--        </foreach>-->
<!--    </update>-->

    <!-- 수정 (PG) -->
    <update id="updateAssets" parameterType="java.util.List">
        UPDATE asset a
        SET
        asset_manufacturer    = v.asset_manufacturer,
        asset_manufactured_at = v.asset_manufactured_at,
        asset_model_name      = v.asset_model_name,
        emp_id                = v.emp_id,
        asset_sn              = v.asset_sn,
        asset_loc             = v.asset_loc,
        asset_issuance_date   = v.asset_issuance_date,
        asset_desc            = v.asset_desc
        FROM (
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.assetId},
            #{item.assetManufacturer},
            #{item.assetManufacturedAt},
            #{item.assetModelName},
            #{item.empId},
            #{item.assetSn},
            #{item.assetLoc},
            #{item.assetIssuanceDate},
            #{item.assetDesc}
            )
        </foreach>
        ) AS v(
        asset_id,
        asset_manufacturer,
        asset_manufactured_at,
        asset_model_name,
        emp_id,
        asset_sn,
        asset_loc,
        asset_issuance_date,
        asset_desc
        )
        WHERE a.asset_id = v.asset_id
    </update>

    <!-- 자산 정보 수정; 폐기처리 (ORA) -->
<!--    <update id="disposeAssets" parameterType="java.util.List">-->
<!--        <foreach collection="list" item="item" separator=";" open="DECLARE BEGIN" close="; END;">-->
<!--            UPDATE asset-->
<!--            SET asset_status = 'N', asset_desc = #{item.assetDesc}-->
<!--            WHERE asset_id = #{item.assetId}-->
<!--        </foreach>-->
<!--    </update>-->

    <!-- 자산 폐기 (PG) -->
    <update id="disposeAssets" parameterType="java.util.List">
        UPDATE asset a
        SET
        asset_status = 'N',
        asset_desc   = v.asset_desc
        FROM (
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.assetId},
            #{item.assetDesc}
            )
        </foreach>
        ) AS v(asset_id, asset_desc)
        WHERE a.asset_id = v.asset_id
    </update>

    <!-- 자산 이력 조회용 스냅샷 -->
    <select id="findSnapshotByAssetId" resultType="com.baek.tbs_miniERP_BACK.dto.AssetSnapshotDTO">
        SELECT
            a.asset_id AS assetId,
            a.emp_id   AS empId,
            (e.emp_name || ' (' || e.emp_id || ')') AS holdEmp,
            a.asset_status AS assetStatus
        FROM asset a
        JOIN employee e ON e.emp_id = a.emp_id
        WHERE a.asset_id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 시리얼번호 조회 (유효성 검증) -->
    <select id="findAllSn">
        SELECT asset_sn
        FROM asset
    </select>
</mapper>